<?php

namespace App\Http\Controllers;

use App\Models\SocieteExploitant;
use App\Models\SocieteExpSite;
use App\Models\SocieteExp;
use Carbon\Carbon;
use Illuminate\Http\Request;
use Validator;
use Illuminate\Validation\Rule;

class SocieteExploitantController extends Controller
{
    /**
     * Display a listing of the resource.
     *
     * @return \Illuminate\Http\Response
     */
    public function index(Request $request){
        $groupe=$request->get('groupe');
        $address=$request->get('address');
        $function='where';
        $pageSize=$request->get('pageSize')?$request->get('pageSize'):10;
        $societeQuery = SocieteExploitant::query();
        if($groupe){
            $societeQuery=$societeQuery->{$function}("groupe","ILIKE","%{$groupe}%");
            $function='orWhere';
        }
        if($address){
            $societeQuery=$societeQuery->{$function}("adresse","ILIKE","%{$address}%");
            $function='orWhere';
        }
        $societe=$societeQuery->orderBy("created_at","DESC")
        ->paginate($pageSize);
        return response([
            "ok"=>true,
            "data"=>$societe
        ],200);
    }
    public function siteExploitBySociete(Request $request){
        SocieteExploitant::where("id_societe");
    }
    public function add(Request $request){
        $validator = Validator::make($request->all(),[
            "id_societe_exploitant"=> ["required","exists:societe_exploitants"],
            "id_sites"=>["required"]
        ],[
            "id_societe_exploitant.exists"=>"Societe d'exploitation n'existe pas",
            "id_sites.required"=>"Les sites sont obligatoires",
            "id_societe_exploitant.required"=>"La société d'exploitation est obligatoire"
        ]);
        if($validator->fails()){
            return response([
                "ok"=>false,
                "message"=>$validator->errors()
            ],400);
        }
        foreach($request["id_sites"] as $id){
            $vald = Validator::make(["id_site"=>$id],["id_site"=>"exists:sites"],["id_site.exists"=>"Le site n'existe pas" ]);
            if($vald->fails()){
                return response([
                    "ok"=>false,
                    "message"=>$vald->errors()
                ],400);
            }
        }
        $array_sites = [];
        foreach($request["id_sites"] as $id){
            $soc = SocieteExpSite::where("id_site","=",$id)->where("typeExploitant","=","Societe")->select("id_societe_exp_site")->first();
            if(!$soc){
                $soc = SocieteExpSite::create([
                    "typeExploitant"=>"Societe",
                    'id_site'=>$id
                ]);
            }
            $temp = [
                "id_societe_exp_site"=>$soc->id_societe_exp_site,
                "id_societe_exploitant"=>$request["id_societe_exploitant"],
                "created_at"=>Carbon::now(),
                "updated_at"=>Carbon::now()
            ];
            array_push($array_sites,$temp);
        }
        $socExp = SocieteExp::insert($array_sites);
        return response([
            "ok"=>true,
            "message"=>$socExp
        ],200);
    }
    /**
     * Show the form for creating a new resource.
     *
     * @return \Illuminate\Http\Response
     */
    public function create(Request $request){
        $rules = [
            "groupe"=>["required"],
            //"logo"=>["required"],
            "codeape"=>['required'],
            "adresse"=>['required'],
            "denomination"=>["required"],
            "serin"=>["required"],
            'nature_juridique'=>["required","exists:enemurations,id_enemuration"],
            "nombreSalarie"=>["numeric"]
        ];
        $message = [
            "required"=>":attribute est obligatoire",
            "nature_juridique.exists"=>"Nature juridique n'existe pas",
            "numeric"=>":attribute doit être un nombre"
        ];
        $validator = Validator::make($request->all(),$rules,$message);
        if($validator->fails()){
            return response([
                "ok"=>'server',
                "errors"=>$validator->errors()
            ],400);
        }
        $societe = SocieteExploitant::create([
            "groupe"=>$request["groupe"],
            //"logo"=>$request["logo"],
            "denomination"=>$request["denomination"],
            "serin"=>$request["serin"],
            "codeape"=>$request["codeape"],
            "adresse"=>$request["adresse"],
            "lat"=>$request['lat'],
            "lang"=>$request['lang'],
            "siteInternet"=>isset($request["siteInternet"])?$request["siteInternet"]:null,
            "telephoneStandrad"=>isset($request["telephoneStandrad"])?$request["telephoneStandrad"]:null,
            "nombreSalarie"=>isset($request["nombreSalarie"])?$request["nombreSalarie"]:null,
            "nature_juridique"=>$request["nature_juridique"]
        ]);
        return response([
            "ok"=>true,
            "data"=>$societe
        ],200);
    }
    /**
     * Display the specified resource.
     *
     * @param  \Illuminate\Http\Request  $request
     * @return \Illuminate\Http\Response
     */
    public function show(Request $request)
    {
        $idCompany=$request['idcompany'];
        if(!empty($idCompany)){
            $societe=SocieteExploitant::with('contacts')->find($idCompany);
            return response([
                'ok'=>true,
                'data'=>$societe
            ],200);
        }
        return response([
            'ok'=>'server',
            'errors'=>'Aucune société disponible'
        ],400);
       
    }

    /**
     * Show the form for editing the specified resource.
     *
     * @param  \Illuminate\Http\Request  $request
     * @return \Illuminate\Http\Response
     */
    public function edit(Request $request)
    {
        $soceExp = SocieteExploitant::find($request["idSociete"]);
        if($soceExp){
            return response([
                "ok"=>true,
                "data"=>$soceExp
            ],200);
        }
        return response([
            "ok"=>"server",
            "errors"=>"Societé n'existe pas"
        ],400);
    }

    /**
     * Update the specified resource in storage.
     *
     * @param  \Illuminate\Http\Request  $request
     * @return \Illuminate\Http\Response
     */
    public function update(Request $request){
        $rules = [
            "id_societe_exploitant"=>["required","exists:societe_exploitants"],
            "groupe"=>["required"],
            //"logo"=>["required"],
            "codeape"=>['required'],
            "adresse"=>['required'],
            "denomination"=>["required"],
            "serin"=>["required"],
            'nature_juridique'=>["required","exists:enemurations,id_enemuration"],
            "nombreSalarie"=>["numeric"]
        ];
        $message = [
            "required"=>":attribute est obligatoire",
            "nature_juridique.exists"=>"Nature juridique n'existe pas",
            "numeric"=>":attribute doit être un nombre"
        ];
        $validator = Validator::make($request->all(),$rules,$message);
        if($validator->fails()){
            return response([
                "ok"=>'server',
                "errors"=>$validator->errors()
            ],400);
        }
        $soceExp = SocieteExploitant::find($request["id_societe_exploitant"]);
        $socU = $soceExp->update($request->all());
        return response([
            "ok"=>true,
            "data"=>"Societé modifiée avec succée"
        ],200);
    }

    /**
     * Remove the specified resource from storage.
     *
     * @param  \App\Models\SocieteExploitant  $societeExploitant
     * @return \Illuminate\Http\Response
     */
    public function destroy(Request $request)
    {
        if(isset($request['societes']) && is_array($request['societes'])){
            $deletedLis=[];
            foreach($request['societes'] as $societe){
                $soci=SocieteExploitant::find($societe);
                if($soci){
                    $deletedLis [] = $societe;
                    $soci->delete();
                }
            }
            return response([
                'ok'=>true,
                'data'=>"async",
                'societes'=>$deletedLis
            ]);
        }
        return response([
            'ok'=>true,
            'data'=>"no action"
        ]);
    }
}